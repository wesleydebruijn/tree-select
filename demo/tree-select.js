"use strict";var L=Object.defineProperty;var x=(s,e,t)=>e in s?L(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>x(s,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function I(s,e,t,n,l=0,i){var r;for(const h of e){const d={_id:`${l}-${h.id}`,parent:i==null?void 0:i._id,children:(r=h.children)==null?void 0:r.map(p=>`${l+1}-${p.id}`),depth:l,id:`${h.id}`,name:h.name,fullName:i?`${i.fullName} ${h.name}`:h.name,checked:!1,indeterminate:!1,collapsed:!0,hidden:!1,itemElement:null,checkboxElement:null,collapseElement:null,childrenElement:null};t(d,n),h.children&&d.childrenElement&&I(s,h.children,t,d.childrenElement,l+1,d),s.set(d._id,d)}}function S(s){return Math.max(...Array.from(s.values()).map(({depth:e})=>e))}function y(s,e){return Array.from(s.values()).filter(t=>t.checked&&t.depth>=e).map(t=>t.id)}function M(s,e){const t=new Set;u(s,n=>{const l=e(n);return l&&n.parent&&t.add(n.parent),{checked:l,indeterminate:!1}});for(const n of t){const l=s.get(n);l&&(E(s,l),m(s,l,i=>E(s,i)))}}function E(s,e){if(!e.children)return;const t=e.children.map(i=>s.get(i)).filter(i=>i!==void 0),n=t.every(i=>i.checked),l=t.some(i=>i.checked||i.indeterminate);e.checked=n,e.indeterminate=!n&&l}function T(s,e){e.length===0?u(s,{hidden:!1,collapsed:!0}):(u(s,{hidden:!0,collapsed:!0}),u(s,t=>{t.fullName.toLowerCase().includes(e.toLowerCase())&&(t.hidden=!1,v(s,t,{hidden:!1}),m(s,t,{hidden:!1,collapsed:!1}))}))}function k(s,e){e.checked=!e.checked,e.indeterminate=!1,v(s,e,{checked:e.checked,indeterminate:!1}),m(s,e,t=>E(s,t))}function O(s,e,t){const n=Array.from(s.values()).filter(p=>p.depth===t.depth),l=n.indexOf(t),i=n.indexOf(e),r=Math.min(l,i),h=Math.max(l,i),d=n.slice(r,h+1);for(const p of d)k(s,p)}function b(s,e,t){M(s,n=>e.includes(n.id)&&n.depth>=t)}function m(s,e,t){if(!e.parent)return;const n=s.get(e.parent);n&&(Object.assign(n,t instanceof Function?t(n):t),m(s,n,t))}function v(s,e,t){if(e.children)for(const n of e.children){const l=s.get(n);l&&(Object.assign(l,t instanceof Function?t(l):t),l.children&&v(s,l,t))}}function u(s,e){for(const t of s.values())Object.assign(t,e instanceof Function?e(t):e)}const V={wrapper:"tree-select-wrapper",control:"tree-select-control",search:"tree-select-search",dropdown:"tree-select-dropdown",heading:"tree-select-heading",headingSpan:"tree-select-heading-span",loading:"tree-select-loading",list:"tree-select-list",item:"tree-select-item",checkbox:"tree-select-checkbox",collapse:"tree-select-collapse",clear:"tree-select-clear",label:"tree-select-label",labelSpan:"tree-select-label-span",children:"tree-select-children"};function f(s,e){let t=null;return function(...n){t&&clearTimeout(t),t=setTimeout(()=>{s.apply(this,n)},e)}}function g(s,e,t){s&&(t?s.classList.add(e):s.classList.remove(e))}function c(s,e){s&&(s.style.display=e?"":"none")}function a(s,e,t){const n=document.createElement(s),{className:l,data:i}=t[e]||{};if(n.classList.add(V[e]),l&&n.classList.add(l),i)for(const[r,h]of Object.entries(i))n.dataset[r]=String(h);return n}function $(s){let e;if(typeof s=="string"?e=document.querySelector(s):e=s,!e)throw new Error(`Element ${s} not found`);if(e.treeSelect)throw new Error("TreeSelect already initialized on element");return e}function C(s,e=","){return s instanceof HTMLInputElement?s.value.split(e):Array.from(s.selectedOptions).map(t=>t.value)}function w(s,e,t=","){if(s instanceof HTMLInputElement)s.value=e.join(t);else{const n=Array.from(s.options),l=new Set(n.map(i=>i.value));for(const i of n)i.selected=e.includes(i.value);for(const i of e)if(!l.has(i)){const r=document.createElement("option");r.value=i,r.text=i,r.selected=!0,s.add(r)}}}class F{constructor(e,t={}){o(this,"settings",{open:!1,clearable:!0,searchable:!0,collapsible:!0,delimiter:",",depthCollapsible:0,depthCollapsed:0,depthCheckboxes:0,depthValues:"last",text:{selected:"selected",clear:"clear",loading:"Loading...",search:"Search..."},html:{}});o(this,"opened",!1);o(this,"loaded",!1);o(this,"loading",!1);o(this,"mounted",!1);o(this,"search","");o(this,"data",[]);o(this,"values",[]);o(this,"items",new Map);o(this,"lastItem",null);o(this,"depth",0);o(this,"depthValues",0);o(this,"rootElement");o(this,"controlElement",null);o(this,"wrapperElement",null);o(this,"dropdownElement",null);o(this,"loadingElement",null);this.settings=Object.assign(this.settings,t),this.onLoad=this.onLoad.bind(this),this.onChange=this.onChange.bind(this),this.onFocus=this.onFocus.bind(this),this.onSearch=this.onSearch.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onClear=this.onClear.bind(this),this.mountItem=this.mountItem.bind(this),this.renderItem=this.renderItem.bind(this),this.rootElement=$(e),this.rootElement.treeSelect=this,this.rootElement.addEventListener("change",this.onChange),this.values=C(this.rootElement,this.settings.delimiter),this.initMount(),this.settings.open&&this.open()}open(){this.opened||(!this.loaded&&!this.loading&&f(()=>this.load(),0)(),this.opened=!0,g(this.controlElement,"focus",!0),c(this.dropdownElement,!0),this.onOpen())}close(){this.opened&&(this.opened=!1,g(this.controlElement,"focus",!1),c(this.dropdownElement,!1),this.onClose())}async load(){return this.settings.dataSrc?fetch(this.settings.dataSrc).then(e=>e.json()).then(this.onLoad):this.onLoad(this.settings.data||[])}destroy(){document.removeEventListener("mousedown",this.onFocus,!0),document.removeEventListener("focus",this.onFocus,!0),this.wrapperElement&&this.wrapperElement.remove(),c(this.rootElement,!0),this.rootElement.treeSelect=null,this.rootElement.removeEventListener("change",this.onChange)}initMount(){this.wrapperElement=a("div","wrapper",this.settings.html),this.wrapperElement.addEventListener("keydown",this.onKeyDown),this.rootElement.after(this.wrapperElement),this.controlElement=a("div","control",this.settings.html),this.controlElement.tabIndex=0,this.controlElement.innerHTML=`${this.values.length} ${this.settings.text.selected}`,this.controlElement.addEventListener("focus",this.onFocus),this.wrapperElement.appendChild(this.controlElement),this.dropdownElement=a("div","dropdown",this.settings.html),c(this.dropdownElement,!1),this.wrapperElement.appendChild(this.dropdownElement);const e=a("div","heading",this.settings.html),t=a("span","headingSpan",this.settings.html);if(this.settings.text.heading&&(t.innerHTML=this.settings.text.heading),e.appendChild(t),this.settings.clearable){const n=a("span","clear",this.settings.html);this.settings.text.clear&&(n.innerHTML=this.settings.text.clear),n.addEventListener("click",this.onClear),e.appendChild(n)}if(this.dropdownElement.appendChild(e),this.settings.searchable){const n=a("input","search",this.settings.html);n.type="search",this.settings.text.search&&(n.placeholder=this.settings.text.search),n.addEventListener("keyup",f(this.onSearch,100)),n.addEventListener("search",f(this.onSearch,100)),this.dropdownElement.appendChild(n)}this.loadingElement=a("div","loading",this.settings.html),this.settings.text.loading&&(this.loadingElement.innerHTML=this.settings.text.loading),this.dropdownElement.appendChild(this.loadingElement),document.addEventListener("mousedown",this.onFocus,!0),document.addEventListener("focus",this.onFocus,!0),c(this.rootElement,!1)}mountItems(){const e=a("div","list",this.settings.html);this.items=new Map,I(this.items,this.data,this.mountItem,e),this.depth=S(this.items),this.depthValues=this.settings.depthValues==="last"?this.depth:this.settings.depthValues,b(this.items,this.values,this.depthValues),this.render(),c(this.loadingElement,!1),this.dropdownElement&&this.dropdownElement.appendChild(e),this.mounted=!0}mountItem(e,t){const n=e.children&&e.depth>=this.settings.depthCollapsible&&this.settings.collapsible,l=e.depth>=this.settings.depthCheckboxes;e.collapsed=e.depth>=this.settings.depthCollapsed,e.itemElement=a("div","item",this.settings.html);const i=a("div","label",this.settings.html);n&&(e.collapseElement=a("div","collapse",this.settings.html),i.appendChild(e.collapseElement)),l&&(e.checkboxElement=a("input","checkbox",this.settings.html),e.checkboxElement.type="checkbox",e.checkboxElement.addEventListener("click",h=>this.onItemSelect(h,e)),i.appendChild(e.checkboxElement));const r=a("span","labelSpan",this.settings.html);r.innerHTML=e.name,i.appendChild(r),(n||l)&&i.addEventListener("click",h=>n?this.onItemCollapse(h,e):this.onItemSelect(h,e)),e.itemElement.appendChild(i),e.children&&(e.childrenElement=a("div","children",this.settings.html),e.itemElement.appendChild(e.childrenElement)),t.appendChild(e.itemElement)}render(){for(const e of this.items.values())this.renderItem(e);this.controlElement&&(this.controlElement.innerHTML=`${this.values.length} ${this.settings.text.selected}`)}renderItem(e){c(e.childrenElement,!e.collapsed||e.depth<this.settings.depthCollapsible||!this.settings.collapsible),c(e.itemElement,!e.hidden),g(e.collapseElement,"collapsed",e.collapsed),e.checkboxElement&&(e.checkboxElement.checked=e.checked,e.checkboxElement.indeterminate=e.indeterminate)}onLoad(e){this.data=e,this.loaded=!0,this.loading=!1,this.mounted||this.mountItems(),this.settings.onLoad&&this.settings.onLoad(e)}onItemSelect(e,t){e.stopPropagation(),e.shiftKey&&this.lastItem?O(this.items,this.lastItem,t):(k(this.items,t),this.lastItem=t),this.values=y(this.items,this.depthValues),w(this.rootElement,this.values,this.settings.delimiter),this.render(),this.settings.onSelect&&this.settings.onSelect(this.values)}onItemCollapse(e,t){t.collapsed=!t.collapsed,this.renderItem(t)}onSearch(e){const t=e.target.value;t!==this.search&&(this.search=t,T(this.items,t),this.render(),this.settings.onSearch&&this.settings.onSearch(t))}onKeyDown(e){e.key==="Escape"&&this.close()}onClear(){u(this.items,{checked:!1,indeterminate:!1}),this.values=[],w(this.rootElement,this.values,this.settings.delimiter),this.render(),this.settings.onClear&&this.settings.onClear()}onOpen(){this.settings.onOpen&&this.settings.onOpen()}onClose(){this.settings.onClose&&this.settings.onClose()}onFocus(e){var t;(t=this.wrapperElement)!=null&&t.contains(e.target)?this.open():this.close()}onChange(e){this.values=C(this.rootElement,this.settings.delimiter),this.mounted&&b(this.items,this.values,this.depthValues),this.render()}}exports.TreeSelect=F;
